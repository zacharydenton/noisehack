<!doctype html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<title>Custom Audio Effects in JavaScript with the Web Audio API</title>
		<meta name="description" content="Learn how to implement custom effects and filters with the Web Audio API.">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="canonical" href="http://noisehack.com/custom-audio-effects-javascript-web-audio-api/">
		<link href="http://fonts.googleapis.com/css?family=Iceberg|Source+Sans+Pro:400,700,400italic,700italic" rel="stylesheet" type="text/css">
		<link rel="stylesheet" href="../css/main.css">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
		<script src="../js/main.js"></script>
	</head>
	<body>
		<header role="banner">
			<h1><a href="http://noisehack.com/">Noisehack</a></h1>
			<nav>
			<ul>
				<li><a href="../about/">About</a></li>
				<li><a href="../archives/">Archives</a></li>
				<li><a href="http://feeds.feedburner.com/noisehack">RSS</a></li>
				<li><a href="https://twitter.com/noisehack">Twitter</a></li>
			</ul>
			</nav>
		</header>

		<div id="container">
		<article>
  <h1>Custom Audio Effects in JavaScript with the Web Audio API</h1>
  <p>You can get pretty far with the built-in Web Audio API nodes, but to really turn things up to 11, you may need to write custom audio effects in JavaScript. This post shows you how.</p>
<!--more-->

<p>To demonstrate the effects, we’ll be using the following reference tone throughout the post:</p>
<pre style="display: none">var effect = audioContext.createGainNode();</pre>
<p><button class="demo">
Reference Tone
</button></p>

<h2 id="simple-lowpass-filter">Simple Lowpass Filter</h2>
<p>Let’s get warmed up with a <a href="http://en.wikipedia.org/wiki/Low-pass_filter#Simple_infinite_impulse_response_filter">simple lowpass filter</a>. This filter simply averages the current input sample with the previous output sample:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> bufferSize = <span class="dv">4096</span>;
<span class="kw">var</span> effect = (<span class="kw">function</span>() {
    <span class="kw">var</span> lastOut = <span class="fl">0.0</span>;
    <span class="kw">var</span> node = <span class="ot">audioContext</span>.<span class="fu">createScriptProcessor</span>(bufferSize, <span class="dv">1</span>, <span class="dv">1</span>);
    <span class="ot">node</span>.<span class="fu">onaudioprocess</span> = <span class="kw">function</span>(e) {
        <span class="kw">var</span> input = <span class="ot">e</span>.<span class="ot">inputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">var</span> output = <span class="ot">e</span>.<span class="ot">outputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">for</span> (<span class="kw">var</span> i = <span class="dv">0</span>; i &lt; bufferSize; i++) {
            output[i] = (input[i] + lastOut) / <span class="fl">2.0</span>;
            lastOut = output[i];
        }
    }
    <span class="kw">return</span> node;
})();</code></pre>
<p><button class="demo">
Simple Lowpass
</button></p>

<p>I don’t know about you, but I could barely tell a difference between that and the reference tone. But take a look at how the effect is coded – this will serve as the basic template for all of the upcoming audio effects.</p>
<p>The first thing to note is the buffer size. Set it too low, and you’ll get audio glitches known as <a href="http://en.wikipedia.org/wiki/Buffer_underrun">buffer underruns</a>. Set it too high, and you’ll introduce latency. Set it to 0, and the Web Audio API will pick a value for you.</p>
<p>Now for the actual filter definition. I’ve wrapped it all in a closure to encapsulate the filter’s internal state (in this case, the previous output sample, <code>lastOut</code>). The <code>AudioNode</code> that actually performs the computation is the <code>ScriptProcessor</code>. To create a <code>ScriptProcessor</code>, use <code>audioContext.createScriptProcessor()</code>:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="ot">audioContext</span>.<span class="fu">createScriptProcessor</span>(bufferSize, numInputChannels, numOutputChannels);</code></pre>
<p>Take a look at how <code>node</code> is instantiated: 1 for <code>numInputChannels</code> and 1 for <code>numOutputChannels</code>. This means that this simple lowpass filter processes audio in mono. The good news is that we don’t have to worry about down-mixing from stereo and up-mixing back to stereo – the Web Audio API takes care of all that automatically.</p>
<p>The magic happens within the <code>onaudioprocess</code> callback. Within this callback, we get access to two buffers: one for reading the incoming audio data, and the other for writing the outgoing audio data. Each of these is an array of size <code>bufferSize</code>. The general pattern for the <code>onaudioprocess</code> callback is to loop through each sample of input, modify it somehow, and write the corresponding sample of output.</p>
<p>At this point, you may be wondering how to actually use this effect. It turns out that these custom effects use exactly the same interface as any other <code>AudioNode</code>:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> oscillator = <span class="ot">audioContext</span>.<span class="fu">createOscillator</span>();
<span class="ot">oscillator</span>.<span class="fu">connect</span>(effect);
<span class="ot">effect</span>.<span class="fu">connect</span>(<span class="ot">audioContext</span>.<span class="fu">destination</span>);</code></pre>
<p>On the other hand, this effect doesn’t really do much, and I can’t think of any reason why you’d use it instead of the existing <code>BiquadFilter</code>. Let’s take a look at some more interesting effects.</p>
<h2 id="pinking-filter">Pinking Filter</h2>
<p>Previously, I demonstrated how to <a href="../generate-noise-web-audio-api/#pink-noise">generate pink noise with the Web Audio API</a>. It was implemented as a series of filters designed to reduce the amplitude of white noise by 3dB per octave. We can use this same filter series on <em>any</em> input signal – not just white noise.</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> bufferSize = <span class="dv">4096</span>;
<span class="kw">var</span> effect = (<span class="kw">function</span>() {
    <span class="kw">var</span> b0, b1, b2, b3, b4, b5, b6;
    b0 = b1 = b2 = b3 = b4 = b5 = b6 = <span class="fl">0.0</span>;
    <span class="kw">var</span> node = <span class="ot">audioContext</span>.<span class="fu">createScriptProcessor</span>(bufferSize, <span class="dv">1</span>, <span class="dv">1</span>);
    <span class="ot">node</span>.<span class="fu">onaudioprocess</span> = <span class="kw">function</span>(e) {
        <span class="kw">var</span> input = <span class="ot">e</span>.<span class="ot">inputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">var</span> output = <span class="ot">e</span>.<span class="ot">outputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">for</span> (<span class="kw">var</span> i = <span class="dv">0</span>; i &lt; bufferSize; i++) {
            b0 = <span class="fl">0.99886</span> * b0 + input[i] * <span class="fl">0.0555179</span>;
            b1 = <span class="fl">0.99332</span> * b1 + input[i] * <span class="fl">0.0750759</span>;
            b2 = <span class="fl">0.96900</span> * b2 + input[i] * <span class="fl">0.1538520</span>;
            b3 = <span class="fl">0.86650</span> * b3 + input[i] * <span class="fl">0.3104856</span>;
            b4 = <span class="fl">0.55000</span> * b4 + input[i] * <span class="fl">0.5329522</span>;
            b5 = -<span class="fl">0.7616</span> * b5 - input[i] * <span class="fl">0.0168980</span>;
            output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + input[i] * <span class="fl">0.5362</span>;
            output[i] *= <span class="fl">0.11</span>; <span class="co">// (roughly) compensate for gain</span>
            b6 = input[i] * <span class="fl">0.115926</span>;
        }
    }
    <span class="kw">return</span> node;
})();</code></pre>
<p><button class="demo">
Pinking Filter
</button></p>

<p>Qualitatively speaking, the filter smooths out the reference tone and makes it less “harsh” – kind of like the relationship between pink noise and white noise.</p>
<p>If you look closely, this filter is using the same basic technique as the simple lowpass filter (averaging the last output sample with the current input sample). The only difference is that now there’s six simple lowpass filters, where previously there was only one. In other words, filter <code>b0</code> averages its last output sample (the previous value of <code>b0</code>) with the current input sample, <code>b1</code> averages its last output sample (the previous value of <code>b1</code>) with the current input sample, and so on. These six filters are then combined together with the appropriate weights to approximate a -3dB/octave filter, in aggregate.</p>
<h2 id="noise-convolver">Noise Convolver</h2>
<p>The <code>ConvolverNode</code> is arguably the most powerful node in the Web Audio arsenal. Combined with JavaScript, it’s absolutely devastating.</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> effect = (<span class="kw">function</span>() {
    <span class="kw">var</span> convolver = <span class="ot">audioContext</span>.<span class="fu">createConvolver</span>(),
        noiseBuffer = <span class="ot">audioContext</span>.<span class="fu">createBuffer</span>(<span class="dv">2</span>, <span class="fl">0.5</span> * <span class="ot">audioContext</span>.<span class="fu">sampleRate</span>, <span class="ot">audioContext</span>.<span class="fu">sampleRate</span>),
        left = <span class="ot">noiseBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>),
        right = <span class="ot">noiseBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">1</span>);
    <span class="kw">for</span> (<span class="kw">var</span> i = <span class="dv">0</span>; i &lt; <span class="ot">noiseBuffer</span>.<span class="fu">length</span>; i++) {
        left[i] = <span class="ot">Math</span>.<span class="fu">random</span>() * <span class="dv">2</span> - <span class="dv">1</span>;
        right[i] = <span class="ot">Math</span>.<span class="fu">random</span>() * <span class="dv">2</span> - <span class="dv">1</span>;
    }
    <span class="ot">convolver</span>.<span class="fu">buffer</span> = noiseBuffer;
    <span class="kw">return</span> convolver;
})();</code></pre>
<p><button class="demo">
Noise Convolver
</button></p>

<p>So what we’ve done here is create 0.5 seconds of stereophonic white noise and a <code>ConvolverNode</code> that uses it. You can create some really interesting effects with this technique: create a sound buffer with JavaScript, then use it to convolve an arbitrary input signal.</p>
<p>If you don’t know much about convolution, that’s OK. I’ll be covering the <code>ConvolverNode</code> in depth in a future post. For now, I’ll just say that you can use it to emulate anything from the reverb of a massive cathedral hall to the tone of a <a href="http://www.amazon.com/dp/B002PYRHFU/?tag=zacden-20">Vox AC30</a>.</p>
<h2 id="moog-filter">Moog Filter</h2>
<p>Many have tried to emulate the <a href="http://en.wikipedia.org/wiki/Minimoog">classic Moog filter</a>; few have succeeded. The following is based on <a href="http://www.musicdsp.org/showArchiveComment.php?ArchiveID=26">a pretty good approximation</a>:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> bufferSize = <span class="dv">4096</span>;
<span class="kw">var</span> effect = (<span class="kw">function</span>() {
    <span class="kw">var</span> node = <span class="ot">audioContext</span>.<span class="fu">createScriptProcessor</span>(bufferSize, <span class="dv">1</span>, <span class="dv">1</span>);
    <span class="kw">var</span> in1, in2, in3, in4, out1, out2, out3, out4;
    in1 = in2 = in3 = in4 = out1 = out2 = out3 = out4 = <span class="fl">0.0</span>;
    <span class="ot">node</span>.<span class="fu">cutoff</span> = <span class="fl">0.065</span>; <span class="co">// between 0.0 and 1.0</span>
    <span class="ot">node</span>.<span class="fu">resonance</span> = <span class="fl">3.99</span>; <span class="co">// between 0.0 and 4.0</span>
    <span class="ot">node</span>.<span class="fu">onaudioprocess</span> = <span class="kw">function</span>(e) {
        <span class="kw">var</span> input = <span class="ot">e</span>.<span class="ot">inputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">var</span> output = <span class="ot">e</span>.<span class="ot">outputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">var</span> f = <span class="ot">node</span>.<span class="fu">cutoff</span> * <span class="fl">1.16</span>;
        <span class="kw">var</span> fb = <span class="ot">node</span>.<span class="fu">resonance</span> * (<span class="fl">1.0</span> - <span class="fl">0.15</span> * f * f);
        <span class="kw">for</span> (<span class="kw">var</span> i = <span class="dv">0</span>; i &lt; bufferSize; i++) {
            input[i] -= out4 * fb;
            input[i] *= <span class="fl">0.35013</span> * (f*f)*(f*f);
            out1 = input[i] + <span class="fl">0.3</span> * in1 + (<span class="dv">1</span> - f) * out1; <span class="co">// Pole 1</span>
            in1 = input[i];
            out2 = out1 + <span class="fl">0.3</span> * in2 + (<span class="dv">1</span> - f) * out2; <span class="co">// Pole 2</span>
            in2 = out1;
            out3 = out2 + <span class="fl">0.3</span> * in3 + (<span class="dv">1</span> - f) * out3; <span class="co">// Pole 3</span>
            in3 = out2;
            out4 = out3 + <span class="fl">0.3</span> * in4 + (<span class="dv">1</span> - f) * out4; <span class="co">// Pole 4</span>
            in4 = out3;
            output[i] = out4;
        }
    }
    <span class="kw">return</span> node;
})();</code></pre>
<p><button class="demo">
Moog Filter
</button></p>

<p>Notice the resonance. The caveat with this approach is that you can’t modulate <code>cutoff</code> and <code>frequency</code> the way you can with a normal <code>AudioParam</code>. I thought I could get around this by creating a dummy <code>BiquadFilter</code> and hijacking its <code>frequency</code> and <code>Q</code> parameters. Unfortunately, the <a href="https://dvcs.w3.org/hg/audio/raw-file/tip/webaudio/specification.html#computedValue-AudioParam-section"><code>computedValue</code> attribute referenced in the docs</a> doesn’t appear to be publicly accessible. If anyone knows a way around this, I’d be very interested to hear about it.</p>
<h2 id="bitcrusher">Bitcrusher</h2>
<p>Let’s take a look at one last effect: the lo-fi bitcrusher (<a href="http://www.musicdsp.org/showArchiveComment.php?ArchiveID=139">based on this code</a>):</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> bufferSize = <span class="dv">4096</span>;
<span class="kw">var</span> effect = (<span class="kw">function</span>() {
    <span class="kw">var</span> node = <span class="ot">audioContext</span>.<span class="fu">createScriptProcessor</span>(bufferSize, <span class="dv">1</span>, <span class="dv">1</span>);
    <span class="ot">node</span>.<span class="fu">bits</span> = <span class="dv">4</span>; <span class="co">// between 1 and 16</span>
    <span class="ot">node</span>.<span class="fu">normfreq</span> = <span class="fl">0.1</span>; <span class="co">// between 0.0 and 1.0</span>
    <span class="kw">var</span> step = <span class="ot">Math</span>.<span class="fu">pow</span>(<span class="dv">1</span>/<span class="dv">2</span>, <span class="ot">node</span>.<span class="fu">bits</span>);
    <span class="kw">var</span> phaser = <span class="dv">0</span>;
    <span class="kw">var</span> last = <span class="dv">0</span>;
    <span class="ot">node</span>.<span class="fu">onaudioprocess</span> = <span class="kw">function</span>(e) {
        <span class="kw">var</span> input = <span class="ot">e</span>.<span class="ot">inputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">var</span> output = <span class="ot">e</span>.<span class="ot">outputBuffer</span>.<span class="fu">getChannelData</span>(<span class="dv">0</span>);
        <span class="kw">for</span> (<span class="kw">var</span> i = <span class="dv">0</span>; i &lt; bufferSize; i++) {
            phaser += <span class="ot">node</span>.<span class="fu">normfreq</span>;
            <span class="kw">if</span> (phaser &gt;= <span class="fl">1.0</span>) {
                phaser -= <span class="fl">1.0</span>;
                last = step * <span class="ot">Math</span>.<span class="fu">floor</span>(input[i] / step + <span class="fl">0.5</span>);
            }
            output[i] = last;
        }
    };
    <span class="kw">return</span> node;
})();</code></pre>
<p><button class="demo">
Bitcrusher
</button></p>

<p>It works by quantizing the input signal. In other words, it samples the input signal every so often, then “holds” that sample until it’s time to sample again (based on the <code>bits</code> and <code>normfreq</code> settings).</p>
<h2 id="conclusion">Conclusion</h2>
<p>Hopefully this will get you started implementing some crazy audio effects. There’s a whole <a href="http://musicdsp.org/">wild world of DSP algorithms</a> out there, just waiting to be implemented in JavaScript.</p>
<p>For a great practical introduction to the art of programming audio effects, I highly recommend <a href="http://www.amazon.com/dp/0240825152/?tag=zacden-20">Designing Audio Effect Plug-Ins in C++</a>. It was published in 2013 and covers the <a href="../research/VAFilterDesign_1.0.3.pdf">cutting-edge of virtual analog filter design</a>, among many other interesting topics.</p>
<p>As I was researching for this article, I noticed there’s not really any good central repository for DSP effects. With the Web Audio API, a <a href="http://glsl.heroku.com/">GLSL sandbox</a> for audio effects is suddenly possible. I think a central repository for open-source audio effects with in-browser previews would be really cool. If anyone is interested in building such a platform, <script type="text/javascript">
<!--
h='&#110;&#x6f;&#x69;&#x73;&#x65;&#104;&#x61;&#x63;&#x6b;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#122;&#x61;&#x63;&#104;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+'let me know'+'<\/'+'a'+'>');
// -->
</script><noscript>let me know (zach at noisehack dot com)</noscript>.</p>
<script>
$(function() {
    var audioContext = new (typeof AudioContext !== "undefined" && AudioContext !== null ? AudioContext : webkitAudioContext);
    var masterGain = audioContext.createGain();
    masterGain.gain.value = 0.1;
    masterGain.connect(audioContext.destination);

    var stopDemo = function($button) {
        $button.removeAttr('disabled');
    };

    var startDemo = function($button) {
        var now = audioContext.currentTime;

        var effect = eval($button.parent().prev('pre').text() + "effect;");
        var sawWave = audioContext.createOscillator();
        sawWave.type = sawWave.SAWTOOTH;
        sawWave.start(now);
        var effectGain = audioContext.createGain();

        effect.connect(effectGain);
        effectGain.connect(masterGain);
        sawWave.connect(effect);

        /* Sweep from A3 to A6. */
        sawWave.frequency.setValueAtTime(220, now);
        sawWave.frequency.linearRampToValueAtTime(1760, now + 4);

        /* Play raw wave through effect, then fade out. */
        effectGain.gain.setValueAtTime(1.0, now);
        effectGain.gain.setValueAtTime(1.0, now + 4);
        effectGain.gain.linearRampToValueAtTime(0.0, now + 5);

        $button.attr('disabled', '');
        setTimeout(function() { stopDemo($button); }, 5000);
    };

    $("button.demo").each(function(i, button) {
        $(button).click(function(e) {
            var $button = $(this);
            if ($button.attr('disabled')) {
                stopDemo($button);
            } else {
                startDemo($button);
            }
        });
    });
});
</script>





  <hr />
  <p>If you enjoyed this post, subscribe to the <a target="_blank" href="http://feedburner.google.com/fb/a/mailverify?uri=noisehack&amp;loc=en_US">Noisehack newsletter</a> or <a href="https://twitter.com/noisehack">follow us on Twitter</a>.
  </p>
  <hr />
  <div id="disqus_thread"></div>
  <script type="text/javascript">
  var disqus_shortname = 'noisehack';
  (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
</article>

		<aside id="sidebar">
<h2>Subscribe</h2>
<ul>
  <li><a href="http://feedburner.google.com/fb/a/mailverify?uri=noisehack&amp;loc=en_US"><i class="icon-envelope"></i> Newsletter</a></li>
  <li><a href="https://twitter.com/noisehack"><i class="icon-twitter"></i> Twitter</a></li>
  <li><a href="http://feeds.feedburner.com/noisehack"><i class="icon-rss"></i> RSS</a></li>
</ul>
<h2>Recent</h2>
<ul class="recent">
  
  <li><a href="../how-to-build-supersaw-synth-web-audio-api/"><i class="icon-asterisk"></i> How to Build a Supersaw Synthesizer with the Web Audio API</a></li>
  
  <li><a href="../custom-audio-effects-javascript-web-audio-api/"><i class="icon-asterisk"></i> Custom Audio Effects in JavaScript with the Web Audio API</a></li>
  
  <li><a href="../how-to-build-monotron-synth-web-audio-api/"><i class="icon-asterisk"></i> How to Build a Monotron Synth with the Web Audio API</a></li>
  
</ul>
</aside>


		<footer>
<p>
Noisehack is brought to you by <a href="http://zacharydenton.com/">Zach Denton</a>.
</p>
<p>
Grab <a href="http://feeds.feedburner.com/noisehack">the RSS feed</a> or <a href="https://twitter.com/noisehack">follow Noisehack on Twitter</a>.
</p>
</footer>

		</div>
	</body>
</html>
